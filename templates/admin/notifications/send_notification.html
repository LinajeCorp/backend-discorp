{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block branding %}
<h1 id="site-name">
    <a href="{% url 'admin:index' %}">üì± {{ site_header|default:"Django administration" }}</a>
</h1>
{% endblock %}

{% block content_title %}
<h1>üîî {{ title }}</h1>
{% endblock %}

{% block content %}
<div class="module aligned">
    <!-- Estad√≠sticas r√°pidas -->
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1;">
            <h3 style="margin: 0; color: #28a745;">üì± {{ stats.total_devices }}</h3>
            <p style="margin: 5px 0 0 0; color: #6c757d;">Dispositivos Activos</p>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1;">
            <h3 style="margin: 0; color: #007bff;">üë• {{ stats.total_users_with_devices }}</h3>
            <p style="margin: 5px 0 0 0; color: #6c757d;">Usuarios con Dispositivos</p>
        </div>
    </div>

    <!-- Formulario de env√≠o -->
    <form method="post" id="notification-form">
        {% csrf_token %}
        
        <fieldset class="module aligned">
            <h2>üìù Datos de la Notificaci√≥n</h2>
            
            <div class="form-row">
                <div>
                    <label for="notification_type" class="required">Tipo de Env√≠o:</label>
                    <select name="notification_type" id="notification_type" required>
                        <option value="">Selecciona el tipo...</option>
                        <option value="broadcast">üì¢ Broadcast (Todos los usuarios)</option>
                        <option value="user">üë§ Usuario espec√≠fico</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row" id="user-selection" style="display: none;">
                <div>
                    <label for="target_user">Usuario Destinatario:</label>
                    <select name="target_user" id="target_user">
                        <option value="">Selecciona un usuario...</option>
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }} ({{ user.first_name }} {{ user.last_name }})</option>
                        {% endfor %}
                    </select>
                    <div id="user-devices-info" style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px; display: none;">
                        <strong>Dispositivos del usuario:</strong>
                        <div id="devices-list"></div>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label for="title" class="required">T√≠tulo:</label>
                    <input type="text" name="title" id="title" maxlength="255" required 
                           placeholder="Ej: Nueva actualizaci√≥n disponible">
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label for="body" class="required">Mensaje:</label>
                    <textarea name="body" id="body" rows="4" required 
                              placeholder="Escribe aqu√≠ el mensaje de la notificaci√≥n..."></textarea>
                </div>
            </div>
        </fieldset>

        <fieldset class="module aligned">
            <h2>‚öôÔ∏è Datos Adicionales (Opcional)</h2>
            
            <div class="form-row">
                <div>
                    <label for="data_action">Acci√≥n:</label>
                    <select name="data_action" id="data_action">
                        <option value="">Sin acci√≥n espec√≠fica</option>
                        <option value="open_app">Abrir aplicaci√≥n</option>
                        <option value="open_url">Abrir URL</option>
                        <option value="open_screen">Abrir pantalla espec√≠fica</option>
                        <option value="refresh_data">Actualizar datos</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label for="data_url">URL/Pantalla:</label>
                    <input type="text" name="data_url" id="data_url" 
                           placeholder="Ej: /products, https://ejemplo.com, HomeScreen">
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label for="data_custom">Datos Personalizados (JSON):</label>
                    <textarea name="data_custom" id="data_custom" rows="3" 
                              placeholder='{"key": "value", "number": 123}'></textarea>
                    <p class="help">Formato JSON v√°lido. Ejemplo: {"product_id": 123, "category": "electronics"}</p>
                </div>
            </div>
        </fieldset>

        <div class="submit-row">
            <input type="submit" value="üöÄ Enviar Notificaci√≥n" class="default" />
            <a href="{% url 'admin:notifications_notificationhistory_changelist' %}" class="button">üìã Ver Historial</a>
        </div>
    </form>
</div>

<!-- Notificaciones recientes -->
{% if recent_notifications %}
<div class="module" style="margin-top: 30px;">
    <h2>üìà Notificaciones Recientes</h2>
    <table>
        <thead>
            <tr>
                <th>T√≠tulo</th>
                <th>Tipo</th>
                <th>Destinatario</th>
                <th>Estado</th>
                <th>Dispositivos</th>
                <th>Fecha</th>
            </tr>
        </thead>
        <tbody>
            {% for notification in recent_notifications %}
            <tr>
                <td><strong>{{ notification.title }}</strong></td>
                <td>{{ notification.type_badge|safe }}</td>
                <td>
                    {% if notification.target_user %}
                        üë§ {{ notification.target_user.username }}
                    {% elif notification.notification_type == 'broadcast' %}
                        üì¢ Todos
                    {% else %}
                        ‚ùì N/A
                    {% endif %}
                </td>
                <td>{{ notification.status_badge|safe }}</td>
                <td>{{ notification.devices_count }}</td>
                <td>{{ notification.created_at|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const notificationType = document.getElementById('notification_type');
    const userSelection = document.getElementById('user-selection');
    const targetUser = document.getElementById('target_user');
    const userDevicesInfo = document.getElementById('user-devices-info');
    const devicesList = document.getElementById('devices-list');

    // Mostrar/ocultar selecci√≥n de usuario
    notificationType.addEventListener('change', function() {
        if (this.value === 'user') {
            userSelection.style.display = 'block';
            targetUser.required = true;
        } else {
            userSelection.style.display = 'none';
            userDevicesInfo.style.display = 'none';
            targetUser.required = false;
        }
    });

    // Obtener dispositivos del usuario seleccionado
    targetUser.addEventListener('change', function() {
        const userId = this.value;
        if (userId) {
            fetch('{% url "admin:ajax_user_devices" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({user_id: parseInt(userId)})
            })
            .then(response => response.json())
            .then(data => {
                if (data.devices) {
                    let devicesHtml = `<strong>${data.user}</strong> tiene ${data.devices_count} dispositivo(s):<br>`;
                    data.devices.forEach(device => {
                        devicesHtml += `‚Ä¢ ${device.name} (${device.type})<br>`;
                    });
                    devicesList.innerHTML = devicesHtml;
                    userDevicesInfo.style.display = 'block';
                } else {
                    devicesList.innerHTML = 'Error obteniendo dispositivos: ' + (data.error || 'Error desconocido');
                    userDevicesInfo.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                devicesList.innerHTML = 'Error de conexi√≥n';
                userDevicesInfo.style.display = 'block';
            });
        } else {
            userDevicesInfo.style.display = 'none';
        }
    });

    // Validar JSON personalizado
    const dataCustom = document.getElementById('data_custom');
    dataCustom.addEventListener('blur', function() {
        if (this.value.trim()) {
            try {
                JSON.parse(this.value);
                this.style.borderColor = '#28a745';
            } catch (e) {
                this.style.borderColor = '#dc3545';
                alert('JSON inv√°lido. Por favor, corrige el formato.');
            }
        } else {
            this.style.borderColor = '';
        }
    });
});
</script>

<style>
.module h2 {
    background: #f8f9fa;
    color: #495057;
    margin: 0;
    padding: 10px 15px;
    border-bottom: 1px solid #dee2e6;
}

.form-row {
    margin-bottom: 15px;
}

.form-row label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
}

.form-row input, .form-row select, .form-row textarea {
    width: 100%;
    max-width: 500px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.help {
    font-size: 11px;
    color: #666;
    margin-top: 5px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

table th, table td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

table th {
    background-color: #f8f9fa;
    font-weight: bold;
}
</style>
{% endblock %}
